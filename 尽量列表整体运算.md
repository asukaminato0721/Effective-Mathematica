# 尽量列表整体运算

一个常识是，矢量化操作（列表整体操作）会更快。而且错误率更低。（想想下标越界）

Mathematica 有大量的列表函数，而且都不会改变输入对象的值。

`Accumulate` , `Differences` , `Total` , `FoldList`

比如想要计算 **前缀积**

```Mathematica
FoldList[list, Times]
```

---

给定一个 list, 如何计算 list 里小于 5 的所有数的和？

几种方法的速度对比

```Mathematica
r=RandomReal[{}, 100000]
```

```Mathematica
Select[r,#<5&]//Total//AbsoluteTiming
```

Select 会生成新列表，速度很慢

纯函数在 list 大的时候会自动编译（而且不会污染变量）

```Mathematica
If[# < 5, #, 0] & /@r//AbsoluteTiming
```

然后是 @Miroox 给出的 `ResourceFunction` 方法

```Mathematica
Pick[r,ResourceFunction["BoolEval"][r<5],1]//Total
```

核心思想是不创造新 list，新 list 会额外分配内存。

---

由 [@hongyang cao](https://github.com/chyanog?tab=repositories) 给出的代码

```Mathematica
r= RandomReal [1, 10^7]; 
```

```Mathematica
If[# <5, #, 0.] &/@r //Total //RepeatedTiming
```

> {0.426, 5.00023 x 10^6}

```Mathematica
Pick [r, ResourceFunction ["BoolEval"] [r < 5], 1] //Total //RepeatedTiming
```

> {0.33, 5.00023 x 10^6}

```Mathematica
Pick[r, Unitize [5, r], 1] //Total //RepeatedTiming
```

> {0.29, 5.00023 x10^6}

```Mathematica
r UnitStep[5-r] //Total //RepeatedTiming
```

> {0.077, 5.00023 x 10^6}
